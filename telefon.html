<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#1a1a2e">
  <title>üé§ Sesli Yazƒ± Mic</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    html, body {
      height: 100%;
      overflow: hidden;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff;
      display: flex;
      flex-direction: column;
      padding: 20px;
      padding-top: env(safe-area-inset-top, 20px);
      padding-bottom: env(safe-area-inset-bottom, 20px);
    }
    
    h1 {
      text-align: center;
      font-size: 22px;
      margin-bottom: 16px;
    }
    
    /* Durum */
    .status {
      text-align: center;
      padding: 14px;
      border-radius: 12px;
      font-size: 15px;
      margin-bottom: 16px;
      background: rgba(255,255,255,0.05);
    }
    
    .status.connected {
      background: rgba(0,210,106,0.2);
      color: #00d26a;
    }
    
    .status.recording {
      background: rgba(255,107,107,0.2);
      color: #ff6b6b;
    }
    
    .status.error {
      background: rgba(255,107,107,0.2);
      color: #ff6b6b;
    }
    
    /* Mikrofon Alanƒ± */
    .mic-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    #micBtn {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #4361ee, #3a0ca3);
      color: white;
      font-size: 80px;
      cursor: pointer;
      box-shadow: 0 15px 50px rgba(67, 97, 238, 0.5);
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    #micBtn:active {
      transform: scale(0.95);
    }
    
    #micBtn.recording {
      background: linear-gradient(135deg, #ff6b6b, #c0392b);
      box-shadow: 0 15px 50px rgba(255,107,107,0.5);
      animation: pulse 1.2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { 
        transform: scale(1); 
        box-shadow: 0 0 0 0 rgba(255,107,107,0.6);
      }
      50% { 
        transform: scale(1.03); 
        box-shadow: 0 0 0 30px rgba(255,107,107,0);
      }
    }
    
    .mic-hint {
      margin-top: 24px;
      font-size: 16px;
      color: #888;
      text-align: center;
    }
    
    /* Ses Seviyesi */
    .level-container {
      width: 100%;
      max-width: 280px;
      margin-top: 24px;
    }
    
    .level-bar {
      height: 12px;
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      overflow: hidden;
    }
    
    .level-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #00d26a, #ffea00, #ff6b6b);
      border-radius: 6px;
      transition: width 0.1s;
    }
    
    /* Metin √ñnizleme */
    .preview {
      margin-top: auto;
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      padding: 16px;
      max-height: 120px;
      overflow-y: auto;
    }
    
    .preview-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }
    
    .preview-text {
      font-size: 14px;
      line-height: 1.5;
      color: #ccc;
      min-height: 40px;
    }
    
    .preview-text:empty::before {
      content: 'Konu≈ümanƒ±z burada g√∂r√ºnecek...';
      color: #555;
    }
    
    /* ƒ∞zin ƒ∞ste Ekranƒ± */
    .permission-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      z-index: 100;
    }
    
    .permission-screen.hidden {
      display: none;
    }
    
    .permission-icon {
      font-size: 80px;
      margin-bottom: 24px;
    }
    
    .permission-title {
      font-size: 24px;
      margin-bottom: 16px;
      text-align: center;
    }
    
    .permission-text {
      font-size: 16px;
      color: #888;
      text-align: center;
      margin-bottom: 32px;
      line-height: 1.6;
    }
    
    .permission-btn {
      padding: 18px 48px;
      border: none;
      border-radius: 30px;
      background: linear-gradient(135deg, #4361ee, #3a0ca3);
      color: white;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(67,97,238,0.4);
    }
  </style>
</head>
<body>

  <!-- ƒ∞zin ƒ∞ste Ekranƒ± -->
  <div class="permission-screen" id="permissionScreen">
    <div class="permission-icon">üé§</div>
    <h2 class="permission-title">Mikrofon ƒ∞zni Gerekli</h2>
    <p class="permission-text">
      Sesli yazƒ± i√ßin mikrofon eri≈üimi gerekiyor.<br>
      ƒ∞zin verdikten sonra bilgisayara ses g√∂nderebilirsiniz.
    </p>
    <button class="permission-btn" id="requestPermBtn">ƒ∞zin Ver</button>
  </div>

  <!-- Ana Ekran -->
  <h1>üé§ Sesli Yazƒ± Mic</h1>
  
  <div class="status" id="status">‚è≥ Baƒülanƒ±yor...</div>
  
  <div class="mic-container">
    <button id="micBtn">üé§</button>
    <p class="mic-hint" id="micHint">Butona basƒ±lƒ± tut ve konu≈ü</p>
    
    <div class="level-container">
      <div class="level-bar">
        <div class="level-fill" id="levelFill"></div>
      </div>
    </div>
  </div>
  
  <div class="preview">
    <div class="preview-label">üìù Metin √ñnizleme</div>
    <div class="preview-text" id="previewText"></div>
  </div>

  <script>
    // Elementler
    const permissionScreen = document.getElementById('permissionScreen');
    const requestPermBtn = document.getElementById('requestPermBtn');
    const micBtn = document.getElementById('micBtn');
    const status = document.getElementById('status');
    const micHint = document.getElementById('micHint');
    const levelFill = document.getElementById('levelFill');
    const previewText = document.getElementById('previewText');
    
    // Deƒüi≈ükenler
    let isRecording = false;
    let recognition = null;
    let finalText = '';
    
    // BroadcastChannel - aynƒ± tarayƒ±cƒ±daki diƒüer sekmelerle ileti≈üim
    let channel = null;
    try {
      channel = new BroadcastChannel('sesli-yazi-channel');
      channel.onmessage = (event) => {
        if (event.data.type === 'pc-closed') {
          setStatus('üìµ Bilgisayar baƒülantƒ±sƒ± kesildi', 'error');
        }
      };
    } catch(e) {
      console.log('BroadcastChannel desteklenmiyor');
    }
    
    // Mikrofon izni kontrol
    async function checkPermission() {
      try {
        const result = await navigator.permissions.query({ name: 'microphone' });
        if (result.state === 'granted') {
          permissionScreen.classList.add('hidden');
          initApp();
        } else if (result.state === 'denied') {
          setStatus('‚ùå Mikrofon izni reddedildi', 'error');
        }
      } catch(e) {
        // permissions API yoksa direkt dene
        permissionScreen.classList.add('hidden');
        initApp();
      }
    }
    
    // ƒ∞zin iste
    requestPermBtn.addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        stream.getTracks().forEach(t => t.stop());
        permissionScreen.classList.add('hidden');
        initApp();
      } catch(e) {
        alert('Mikrofon izni verilemedi: ' + e.message);
      }
    });
    
    // Uygulama ba≈ülat
    function initApp() {
      // Speech Recognition kontrol
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        setStatus('‚ùå Bu tarayƒ±cƒ± desteklemiyor', 'error');
        micBtn.disabled = true;
        return;
      }
      
      setStatus('‚úÖ Hazƒ±r! Butona basƒ±lƒ± tut', 'connected');
      sendToPC('connected');
      
      // Touch events
      micBtn.addEventListener('touchstart', startRecording, { passive: false });
      micBtn.addEventListener('touchend', stopRecording);
      micBtn.addEventListener('touchcancel', stopRecording);
      
      // Mouse events (test i√ßin)
      micBtn.addEventListener('mousedown', startRecording);
      micBtn.addEventListener('mouseup', stopRecording);
      micBtn.addEventListener('mouseleave', stopRecording);
    }
    
    // Kayƒ±t ba≈ülat
    async function startRecording(e) {
      e.preventDefault();
      if (isRecording) return;
      
      try {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SR();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'tr-TR';
        
        recognition.onstart = () => {
          isRecording = true;
          micBtn.classList.add('recording');
          micBtn.textContent = 'üî¥';
          setStatus('üé§ Dinliyorum...', 'recording');
          micHint.textContent = 'Bƒ±rakƒ±nca durur';
          sendToPC('recording');
        };
        
        recognition.onresult = (event) => {
          let interim = '';
          let newFinal = '';
          
          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              newFinal += transcript + ' ';
            } else {
              interim = transcript;
            }
          }
          
          if (newFinal) {
            finalText += newFinal;
          }
          
          const fullText = finalText + interim;
          previewText.textContent = fullText;
          sendToPC('text', fullText);
          
          // Ses seviyesi sim√ºlasyonu (ger√ßek i√ßin AudioContext gerekir)
          const level = Math.min(100, Math.random() * 60 + 20);
          levelFill.style.width = level + '%';
          sendToPC('level', level);
        };
        
        recognition.onerror = (event) => {
          if (event.error === 'no-speech') {
            // Sessizlik, sorun deƒüil
          } else if (event.error === 'not-allowed') {
            setStatus('‚ùå Mikrofon izni gerekli', 'error');
            stopRecording();
          }
        };
        
        recognition.onend = () => {
          if (isRecording) {
            // Devam ettirmeye √ßalƒ±≈ü
            try { recognition.start(); } catch(e) {}
          }
        };
        
        recognition.start();
        
      } catch(e) {
        setStatus('‚ùå Hata: ' + e.message, 'error');
      }
    }
    
    // Kayƒ±t durdur
    function stopRecording() {
      if (!isRecording) return;
      
      isRecording = false;
      micBtn.classList.remove('recording');
      micBtn.textContent = 'üé§';
      setStatus('‚úÖ Hazƒ±r! Butona basƒ±lƒ± tut', 'connected');
      micHint.textContent = 'Butona basƒ±lƒ± tut ve konu≈ü';
      levelFill.style.width = '0%';
      
      try {
        recognition?.stop();
      } catch(e) {}
      
      sendToPC('stopped');
      sendToPC('level', 0);
    }
    
    // Bilgisayara mesaj g√∂nder
    function sendToPC(type, data) {
      if (!channel) return;
      
      try {
        if (type === 'text') {
          channel.postMessage({ type: 'text', text: data });
        } else if (type === 'level') {
          channel.postMessage({ type: 'level', level: data });
        } else {
          channel.postMessage({ type: type });
        }
      } catch(e) {}
    }
    
    // Durum g√ºncelle
    function setStatus(text, type) {
      status.textContent = text;
      status.className = 'status ' + (type || '');
    }
    
    // Sayfa kapanƒ±rken
    window.addEventListener('beforeunload', () => {
      sendToPC('disconnected');
    });
    
    // Ba≈ülat
    checkPermission();
  </script>

</body>
</html>
