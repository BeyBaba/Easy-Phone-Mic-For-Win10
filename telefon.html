<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#1a1a2e">
  <title>üé§ Sesli Yazƒ± Mic</title>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    html, body {
      height: 100%;
      overflow: hidden;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff;
      display: flex;
      flex-direction: column;
      padding: 20px;
      padding-top: env(safe-area-inset-top, 20px);
    }
    
    h1 {
      text-align: center;
      font-size: 22px;
      margin-bottom: 16px;
    }
    
    /* Baƒülantƒ± Kutusu */
    .connect-box {
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .connect-box.hidden { display: none; }
    
    .connect-label {
      font-size: 14px;
      color: #888;
      margin-bottom: 12px;
      text-align: center;
    }
    
    .code-input-wrapper {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .code-input {
      width: 100%;
      padding: 20px;
      border: 2px solid #4361ee;
      border-radius: 12px;
      background: #0a0a15;
      color: #fff;
      font-size: 28px;
      font-family: 'Courier New', monospace;
      text-align: center;
      letter-spacing: 6px;
      text-transform: uppercase;
      outline: none;
    }
    
    .code-input::placeholder {
      color: #444;
      letter-spacing: 2px;
      font-size: 16px;
    }
    
    .connect-btn {
      width: 100%;
      padding: 20px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #4361ee, #3a0ca3);
      color: white;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    .connect-btn:active {
      transform: scale(0.98);
      opacity: 0.9;
    }
    
    .connect-btn:disabled {
      background: #333;
      cursor: not-allowed;
    }
    
    /* Durum */
    .status {
      text-align: center;
      padding: 14px;
      border-radius: 12px;
      font-size: 15px;
      margin-bottom: 16px;
      background: rgba(255,255,255,0.05);
    }
    
    .status.connected { background: rgba(0,210,106,0.2); color: #00d26a; }
    .status.recording { background: rgba(255,107,107,0.2); color: #ff6b6b; }
    .status.error { background: rgba(255,107,107,0.2); color: #ff6b6b; }
    
    /* Mikrofon Alanƒ± */
    .mic-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .mic-container.disabled {
      opacity: 0.3;
      pointer-events: none;
    }
    
    #micBtn {
      width: 160px;
      height: 160px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #4361ee, #3a0ca3);
      color: white;
      font-size: 70px;
      cursor: pointer;
      box-shadow: 0 15px 50px rgba(67, 97, 238, 0.5);
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
    }
    
    #micBtn:disabled {
      background: #333;
      box-shadow: none;
      cursor: not-allowed;
    }
    
    #micBtn.recording {
      background: linear-gradient(135deg, #ff6b6b, #c0392b);
      box-shadow: 0 15px 50px rgba(255,107,107,0.5);
      animation: pulse 1.2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,107,107,0.6); }
      50% { transform: scale(1.03); box-shadow: 0 0 0 25px rgba(255,107,107,0); }
    }
    
    .mic-hint {
      margin-top: 20px;
      font-size: 15px;
      color: #888;
      text-align: center;
    }
    
    /* Ses Seviyesi */
    .level-container {
      width: 100%;
      max-width: 260px;
      margin-top: 20px;
    }
    
    .level-bar {
      height: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 5px;
      overflow: hidden;
    }
    
    .level-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #00d26a, #ffea00, #ff6b6b);
      transition: width 0.1s;
    }
    
    /* √ñnizleme */
    .preview {
      margin-top: auto;
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      padding: 14px;
      max-height: 100px;
      overflow-y: auto;
    }
    
    .preview-label {
      font-size: 11px;
      color: #666;
      margin-bottom: 6px;
    }
    
    .preview-text {
      font-size: 13px;
      line-height: 1.4;
      color: #ccc;
      min-height: 30px;
    }
    
    .preview-text:empty::before {
      content: 'Konu≈ümanƒ±z burada g√∂r√ºnecek...';
      color: #444;
    }
  </style>
</head>
<body>

  <h1>üé§ Sesli Yazƒ± Mic</h1>
  
  <!-- Baƒülantƒ± Kutusu -->
  <div class="connect-box" id="connectBox">
    <div class="connect-label">Bilgisayardaki 6 haneli kodu gir:</div>
    <div class="code-input-wrapper">
      <input type="text" class="code-input" id="codeInput" placeholder="ABC123" maxlength="6" autocomplete="off" autocapitalize="characters">
      <button class="connect-btn" id="connectBtn">BAƒûLAN</button>
    </div>
  </div>
  
  <div class="status" id="status">‚ö™ Kodu gir ve baƒülan</div>
  
  <div class="mic-container disabled" id="micContainer">
    <button id="micBtn" disabled>üé§</button>
    <p class="mic-hint" id="micHint">√ñnce bilgisayara baƒülan</p>
    
    <div class="level-container">
      <div class="level-bar">
        <div class="level-fill" id="levelFill"></div>
      </div>
    </div>
  </div>
  
  <div class="preview">
    <div class="preview-label">üìù Metin √ñnizleme</div>
    <div class="preview-text" id="previewText"></div>
  </div>

  <script>
    // Elementler
    const connectBox = document.getElementById('connectBox');
    const codeInput = document.getElementById('codeInput');
    const connectBtn = document.getElementById('connectBtn');
    const statusEl = document.getElementById('status');
    const micContainer = document.getElementById('micContainer');
    const micBtn = document.getElementById('micBtn');
    const micHint = document.getElementById('micHint');
    const levelFill = document.getElementById('levelFill');
    const previewText = document.getElementById('previewText');
    
    let peer = null;
    let conn = null;
    let isConnected = false;
    let isRecording = false;
    let recognition = null;
    let finalText = '';
    
    // Baƒülan butonuna tƒ±kla
    connectBtn.addEventListener('click', connect);
    codeInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') connect();
    });
    
    // Baƒülantƒ± kur
    function connect() {
      const code = codeInput.value.trim().toUpperCase();
      if (code.length < 4) {
        setStatus('‚ùå Ge√ßerli bir kod gir!', 'error');
        return;
      }
      
      setStatus('üîÑ Baƒülanƒ±yor...', '');
      connectBtn.disabled = true;
      
      // PeerJS ile baƒülan
      const peerId = 'sesli-' + code;
      
      peer = new Peer();
      
      peer.on('open', () => {
        console.log('Peer a√ßƒ±ldƒ±, baƒülanƒ±lƒ±yor:', peerId);
        conn = peer.connect(peerId, { reliable: true });
        
        conn.on('open', () => {
          console.log('Baƒülantƒ± kuruldu!');
          isConnected = true;
          connectBox.classList.add('hidden');
          setStatus('‚úÖ Baƒülandƒ±! Butona basƒ±lƒ± tut', 'connected');
          
          micContainer.classList.remove('disabled');
          micBtn.disabled = false;
          micHint.textContent = 'Butona basƒ±lƒ± tut ve konu≈ü';
          
          // Mikrofon izni al
          requestMicPermission();
        });
        
        conn.on('close', () => {
          setStatus('üìµ Baƒülantƒ± kesildi', 'error');
          isConnected = false;
          micBtn.disabled = true;
          connectBox.classList.remove('hidden');
          connectBtn.disabled = false;
        });
        
        conn.on('error', (err) => {
          console.error('Baƒülantƒ± hatasƒ±:', err);
          setStatus('‚ùå Baƒülantƒ± hatasƒ±!', 'error');
          connectBtn.disabled = false;
        });
      });
      
      peer.on('error', (err) => {
        console.error('Peer hatasƒ±:', err);
        if (err.type === 'peer-unavailable') {
          setStatus('‚ùå Kod bulunamadƒ±! Doƒüru mu?', 'error');
        } else {
          setStatus('‚ùå Hata: ' + err.type, 'error');
        }
        connectBtn.disabled = false;
      });
    }
    
    // Mikrofon izni
    async function requestMicPermission() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        stream.getTracks().forEach(t => t.stop());
        console.log('Mikrofon izni alƒ±ndƒ±');
      } catch(e) {
        setStatus('‚ùå Mikrofon izni gerekli!', 'error');
        micBtn.disabled = true;
      }
    }
    
    // Mikrofon butonuna bas
    micBtn.addEventListener('touchstart', startRecording, { passive: false });
    micBtn.addEventListener('touchend', stopRecording);
    micBtn.addEventListener('touchcancel', stopRecording);
    micBtn.addEventListener('mousedown', startRecording);
    micBtn.addEventListener('mouseup', stopRecording);
    micBtn.addEventListener('mouseleave', stopRecording);
    
    // Kayƒ±t ba≈ülat
    async function startRecording(e) {
      e.preventDefault();
      if (!isConnected || isRecording) return;
      
      try {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SR) {
          setStatus('‚ùå Bu tarayƒ±cƒ± desteklemiyor', 'error');
          return;
        }
        
        recognition = new SR();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'tr-TR';
        
        recognition.onstart = () => {
          isRecording = true;
          micBtn.classList.add('recording');
          micBtn.textContent = 'üî¥';
          setStatus('üé§ Dinliyorum...', 'recording');
          micHint.textContent = 'Bƒ±rakƒ±nca durur';
          sendToPC({ type: 'recording' });
        };
        
        recognition.onresult = (event) => {
          let interim = '';
          let newFinal = '';
          
          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              newFinal += transcript + ' ';
            } else {
              interim = transcript;
            }
          }
          
          if (newFinal) finalText += newFinal;
          
          const fullText = finalText + interim;
          previewText.textContent = fullText;
          sendToPC({ type: 'text', text: fullText });
          
          // Ses seviyesi sim√ºlasyonu
          const level = Math.min(100, Math.random() * 50 + 30);
          levelFill.style.width = level + '%';
          sendToPC({ type: 'level', level: level });
        };
        
        recognition.onerror = (event) => {
          if (event.error === 'no-speech') {
            // Sessizlik, devam et
          } else if (event.error === 'not-allowed') {
            setStatus('‚ùå Mikrofon izni gerekli', 'error');
            stopRecording();
          }
        };
        
        recognition.onend = () => {
          if (isRecording) {
            try { recognition.start(); } catch(e) {}
          }
        };
        
        recognition.start();
        
      } catch(e) {
        setStatus('‚ùå Hata: ' + e.message, 'error');
      }
    }
    
    // Kayƒ±t durdur
    function stopRecording() {
      if (!isRecording) return;
      
      isRecording = false;
      micBtn.classList.remove('recording');
      micBtn.textContent = 'üé§';
      setStatus('‚úÖ Baƒülƒ± - Butona basƒ±lƒ± tut', 'connected');
      micHint.textContent = 'Butona basƒ±lƒ± tut ve konu≈ü';
      levelFill.style.width = '0%';
      
      try { recognition?.stop(); } catch(e) {}
      
      sendToPC({ type: 'stopped' });
      sendToPC({ type: 'level', level: 0 });
    }
    
    // Bilgisayara mesaj g√∂nder
    function sendToPC(data) {
      if (conn && conn.open) {
        conn.send(data);
      }
    }
    
    // Durum g√ºncelle
    function setStatus(text, type) {
      statusEl.textContent = text;
      statusEl.className = 'status ' + (type || '');
    }
    
    // Sayfa kapanƒ±rken
    window.addEventListener('beforeunload', () => {
      if (conn) conn.close();
      if (peer) peer.destroy();
    });
  </script>

</body>
</html>
